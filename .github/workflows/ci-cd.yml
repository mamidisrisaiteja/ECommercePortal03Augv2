name: ECommerce Portal - Test Automation CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run tests daily at 6 AM UTC
    - cron: '0 6 * * *'
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Test suite to run'
        required: true
        default: 'smoke'
        type: choice
        options:
        - smoke
        - auth
        - inventory
        - all

permissions:
  contents: read
  pages: write
  id-token: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
      fail-fast: false
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'
        
    - name: ï¿½ Cache Playwright Browsers
      uses: actions/cache@v4
      id: playwright-cache
      with:
        path: |
          ~/.cache/ms-playwright
        key: playwright-${{ matrix.browser }}-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          playwright-${{ matrix.browser }}-
        
    - name: ï¿½ğŸ“¦ Install Dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: ğŸ­ Install Playwright with Dependencies
      run: |
        echo "Installing Playwright browsers for ${{ matrix.browser }}"
        # Update package lists first
        sudo apt-get update -qq
        
        # Install specific packages for Ubuntu 24.04 (Noble) - use runtime packages, not dev packages
        echo "Installing system dependencies for Ubuntu 24.04..."
        sudo apt-get install -y \
          libasound2t64 \
          libatk-bridge2.0-0 \
          libatk1.0-0 \
          libdrm2 \
          libgtk-3-0 \
          libnspr4 \
          libnss3 \
          libx11-xcb1 \
          libxcomposite1 \
          libxdamage1 \
          libxfixes3 \
          libxrandr2 \
          libxss1 \
          libxtst6 \
          libdbus-glib-1-2 \
          xvfb
        
        # Install Playwright system dependencies
        echo "Installing Playwright system dependencies..."
        sudo playwright install-deps
        
        # Install ALL browsers first to ensure dependencies are met
        echo "Installing all Playwright browsers to ensure dependencies..."
        playwright install
        
        # Verify the specific browser installation
        echo "Verifying ${{ matrix.browser }} browser installation..."
        playwright install ${{ matrix.browser }}
        
        # List installed browsers for debugging
        ls -la ~/.cache/ms-playwright/ || echo "Browser cache directory not found"
        
    - name: ğŸ”§ Verify Playwright Installation
      run: |
        playwright --version
        python -c "from playwright.sync_api import sync_playwright; print('Playwright import successful')"
        
    - name: ğŸ–¥ï¸ Display System Info
      run: |
        echo "OS Info: $(lsb_release -d | cut -f2)"
        echo "Python Version: $(python --version)"
        echo "Playwright Version: $(playwright --version)"
        echo "Available browsers: $(ls ~/.cache/ms-playwright/ 2>/dev/null || echo 'No browsers cached')"
        
    - name: ğŸ§ª Run Smoke Tests (Default)
      if: github.event_name != 'workflow_dispatch'
      env:
        CI: true
        PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      run: |
        echo "Running smoke tests on ${{ matrix.browser }}"
        # Verify browser installation before running tests
        if [ ! -d "~/.cache/ms-playwright/${{ matrix.browser }}-"* ]; then
          echo "Browser not found, ensuring installation..."
          playwright install ${{ matrix.browser }}
        fi
        
        # Create reports directory
        mkdir -p reports/html
        
        python -m pytest step_definitions/ -m smoke \
          --html=reports/html/smoke_report_${{ matrix.browser }}.html \
          --self-contained-html \
          --test-browser=${{ matrix.browser }} \
          --headless \
          -v --tb=short \
          --maxfail=5
          
    - name: ğŸ§ª Run Selected Test Suite (Manual Trigger)
      if: github.event_name == 'workflow_dispatch'
      env:
        CI: true
        PLAYWRIGHT_BROWSERS_PATH: ~/.cache/ms-playwright
      run: |
        echo "Running ${{ github.event.inputs.test_suite }} tests on ${{ matrix.browser }}"
        # Verify browser installation before running tests
        if [ ! -d "~/.cache/ms-playwright/${{ matrix.browser }}-"* ]; then
          echo "Browser not found, ensuring installation..."
          playwright install ${{ matrix.browser }}
        fi
        
        # Create reports directory
        mkdir -p reports/html
        
        if [ "${{ github.event.inputs.test_suite }}" = "all" ]; then
          python -m pytest step_definitions/ \
            --html=reports/html/full_report_${{ matrix.browser }}.html \
            --self-contained-html \
            --test-browser=${{ matrix.browser }} \
            --headless \
            -v --tb=short \
            --maxfail=10
        else
          python -m pytest step_definitions/ -m ${{ github.event.inputs.test_suite }} \
            --html=reports/html/${{ github.event.inputs.test_suite }}_report_${{ matrix.browser }}.html \
            --self-contained-html \
            --test-browser=${{ matrix.browser }} \
            --headless \
            -v --tb=short \
            --maxfail=5
        fi
        
    - name: ğŸ“¸ Upload Screenshots on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: screenshots-${{ matrix.browser }}-${{ github.run_number }}
        path: reports/screenshots/
        retention-days: 30
        
    - name: ğŸ¥ Upload Videos on Failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: videos-${{ matrix.browser }}-${{ github.run_number }}
        path: reports/videos/
        retention-days: 30
        
    - name: ğŸ“Š Upload Test Reports
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-reports-${{ matrix.browser }}-${{ github.run_number }}
        path: reports/html/
        retention-days: 30

  publish-reports:
    name: Publish Test Reports
    needs: test
    runs-on: ubuntu-latest
    if: always()
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ“¥ Download All Test Reports
      uses: actions/download-artifact@v4
      with:
        pattern: test-reports-*
        path: ./all-reports
        merge-multiple: true
        
    - name: ğŸ“‹ Generate Test Summary
      run: |
        echo "# ğŸ§ª Test Execution Summary" > test-summary.md
        echo "" >> test-summary.md
        echo "**Build:** #${{ github.run_number }}" >> test-summary.md
        echo "**Commit:** ${{ github.sha }}" >> test-summary.md
        echo "**Branch:** ${{ github.ref_name }}" >> test-summary.md
        echo "**Triggered by:** ${{ github.event_name }}" >> test-summary.md
        echo "**Date:** $(date)" >> test-summary.md
        echo "" >> test-summary.md
        echo "## ğŸ“Š Test Reports by Browser" >> test-summary.md
        echo "" >> test-summary.md
        
        for browser in chromium firefox webkit; do
          echo "### ğŸŒ $browser" >> test-summary.md
          if [ -f "./all-reports/smoke_report_${browser}.html" ]; then
            echo "- âœ… [Smoke Tests Report](./smoke_report_${browser}.html)" >> test-summary.md
          fi
          if [ -f "./all-reports/auth_report_${browser}.html" ]; then
            echo "- ğŸ” [Authentication Tests Report](./auth_report_${browser}.html)" >> test-summary.md
          fi
          if [ -f "./all-reports/inventory_report_${browser}.html" ]; then
            echo "- ğŸ“¦ [Inventory Tests Report](./inventory_report_${browser}.html)" >> test-summary.md
          fi
          if [ -f "./all-reports/full_report_${browser}.html" ]; then
            echo "- ğŸ“‹ [Full Test Suite Report](./full_report_${browser}.html)" >> test-summary.md
          fi
          echo "" >> test-summary.md
        done
        
        echo "## ğŸ“ˆ Artifacts" >> test-summary.md
        echo "- Test reports are available as GitHub Action artifacts" >> test-summary.md
        echo "- Screenshots and videos available for failed tests" >> test-summary.md
        
    - name: ğŸ“¤ Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v4
      if: github.ref == 'refs/heads/main'
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./all-reports
        destination_dir: test-reports/${{ github.run_number }}
        
    - name: ğŸ’¬ Comment PR with Test Results
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const summary = fs.readFileSync('test-summary.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: summary
          });

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ”„ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        
    - name: ğŸ”’ Run Security Scan with Bandit
      run: |
        pip install bandit[toml]
        bandit -r . -f json -o bandit-report.json || true
        
    - name: ğŸ“„ Upload Security Report
      uses: actions/upload-artifact@v4
      with:
        name: security-report-${{ github.run_number }}
        path: bandit-report.json
        retention-days: 30
